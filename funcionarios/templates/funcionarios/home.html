{% extends 'funcionarios/base.html' %}

{% block title %}Página Inicial - {{ funcionario_data.nome_completo }}{% endblock %}

{% block content %}

<div class="card mb-4">
    <div class="card-header fw-bold">
        Relógio de Ponto Virtual
    </div>
    <div class="card-body text-center">
        {% if funcionario_data.status_operacional == 'OFFLINE' %}
            <form action="{% url 'funcionarios:bate_ponto' %}" method="post" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="tipo_ponto" value="ENTRADA">
                <button type="submit" class="btn btn-primary btn-lg">Registrar Entrada</button>
            </form>
        {% elif funcionario_data.status_operacional == 'DISPONIVEL' %}
            <div class="btn-group" role="group" aria-label="Ações de Pausa">
                {% if proxima_pausa_regra %}
                    <form action="{% url 'funcionarios:bate_ponto' %}" method="post" class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="tipo_ponto" value="SAIDA_PAUSA">
                        <button type="submit" class="btn btn-info">
                            Pausa Programada ({{ proxima_pausa_regra.nome }})
                        </button>
                    </form>
                {% endif %}
                <form action="{% url 'funcionarios:bate_ponto' %}" method="post" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="tipo_ponto" value="SAIDA_PAUSA_PESSOAL">
                    <button type="submit" class="btn btn-secondary">Pausa Pessoal</button>
                </form>
            </div>
            <form action="{% url 'funcionarios:bate_ponto' %}" method="post" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="tipo_ponto" value="SAIDA">
                <button type="submit" class="btn btn-danger ms-3">Registrar Saída</button>
            </form>
        {% elif funcionario_data.status_operacional == 'EM_PAUSA' %}
            <form action="{% url 'funcionarios:bate_ponto' %}" method="post" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="tipo_ponto" value="VOLTA_PAUSA">
                <button type="submit" class="btn btn-success btn-lg">
                    Voltar da Pausa <span class="badge bg-light text-dark pause-timer" data-pausestart="{{ ultima_pausa.timestamp.isoformat }}"></span>
                </button>
            </form>
        {% endif %}
        <hr>
        <div class="mt-3">
            <p>
                <strong>Status Operacional:</strong>
                {% if funcionario_data.status_operacional == 'DISPONIVEL' %}
                    <span class="badge bg-success">{{ funcionario_data.get_status_operacional_display }}</span>
                {% elif funcionario_data.status_operacional == 'EM_PAUSA' %}
                    <span class="badge bg-warning text-dark">{{ funcionario_data.get_status_operacional_display }}</span>
                    {% if ultima_pausa %}
                    <span class="text-muted small pause-timer" data-pausestart="{{ ultima_pausa.timestamp.isoformat }}"></span>
                    {% endif %}
                    {% if hora_fim_pausa %}
                    <span id="break-countdown" class="badge bg-danger ms-2" data-break-end-time="{{ hora_fim_pausa }}"></span>
                    {% endif %}
                {% else %}
                    <span class="badge bg-secondary">{{ funcionario_data.get_status_operacional_display }}</span>
                {% endif %}
            </p>
            <p class="mb-0">
                <strong>Saldo do Banco de Horas:</strong>
                <span class="{% if saldo_banco_horas_negativo %}text-danger{% else %}text-success{% endif %} fw-bold">
                    {{ saldo_banco_horas }}
                </span>
            </p>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-sm mb-0">
            <thead>
                <tr>
                    <th scope="col">Últimos Registros</th>
                    <th scope="col" class="text-end">Data e Hora</th>
                </tr>
            </thead>
            <tbody>
                {% for registro in funcionario_data.registros_ponto.all|slice:":5" %}
                <tr>
                    <td>{{ registro.get_tipo_display }}</td>
                    <td class="text-end">{{ registro.timestamp|date:"d/m/Y H:i:s" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="2">Nenhum registro hoje.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% if ultimo_ponto_entrada and funcionario_data.status_operacional != 'OFFLINE' %}
<div class="card mb-4">
    <div class="card-body text-center">
        <h5 class="card-title">Tempo Logado</h5>
        <p class="card-text fs-4 fw-bold" id="logged-in-timer" data-start-time="{{ ultimo_ponto_entrada.timestamp.isoformat }}"></p>
    </div>
</div>
{% endif %}

<div class="card mb-4">
    <div class="card-body">
        <div class="d-grid gap-2">
            <a href="{% url 'funcionarios:relatorio_folha_ponto' %}" class="btn btn-outline-primary">Acessar Relatório de Folha de Ponto</a>
            <a href="{% url 'funcionarios:solicitar_abono' %}" class="btn btn-outline-info">Solicitar Abono de Falta/Horas</a>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h2">Seus Dados Cadastrais</h1>
    <a href="{% url 'funcionarios:logout' %}" class="btn btn-danger btn-sm">Sair do Sistema</a>
</div>

<div class="card mb-4">
    <div class="card-header">
        Informações Pessoais e Documentos
    </div>
    <div class="card-body">
        <p><strong>Nome Completo:</strong> {{ funcionario_data.nome_completo }}</p>
        <p><strong>Status:</strong> {{ funcionario_data.get_status_display }}</p>
        <p><strong>Matrícula:</strong> {{ funcionario_data.user.username }}</p>
        <p><strong>Email Corporativo:</strong> {{ funcionario_data.user.email }}</p>
        <p><strong>Email Pessoal:</strong> {{ funcionario_data.email_pessoal|default:"Não informado" }}</p>
        <p><strong>Telefone Celular:</strong> {{ funcionario_data.telefone_celular|default:"Não informado" }}</p>
        <p><strong>Data de Nascimento:</strong> {{ funcionario_data.data_nascimento | date:"d/m/Y" }}</p>
        <p><strong>Escolaridade:</strong> {{ funcionario_data.get_escolaridade_display|default:"Não informado" }}</p>
        <p><strong>CPF:</strong> {{ funcionario_data.cpf }}</p>
        <p><strong>RG:</strong> {{ funcionario_data.rg }}</p>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Endereço</div>
    <div class="card-body">
        <p><strong>CEP:</strong> {{ funcionario_data.cep }}</p>
        <p><strong>Rua:</strong> {{ funcionario_data.rua }}, Nº {{ funcionario_data.numero }}</p>
        <p><strong>Complemento:</strong> {{ funcionario_data.complemento|default:"N/A" }}</p>
        <p><strong>Bairro:</strong> {{ funcionario_data.bairro }}</p>
        <p><strong>Cidade/Estado:</strong> {{ funcionario_data.cidade }} / {{ funcionario_data.estado }}</p>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">Dados de Trabalho</div>
            <div class="card-body">
                <p><strong>Data de Contratação:</strong> {{ funcionario_data.data_contratacao|date:"d/m/Y" }}</p>
                <p><strong>Cargo:</strong> {{ funcionario_data.cargo.nome|default:"Não informado" }}</p>
                <p><strong>Escala Atual:</strong> {{ escala_atual.escala.nome|default:"Nenhuma escala atribuída" }}</p>
                {% if escala_atual %}
                    <p><strong>Horário de Entrada:</strong> {{ escala_atual.escala.horario_entrada|time:"H:i" }}</p>
                    <p><strong>Horário de Saída:</strong> {{ escala_atual.escala.horario_saida|time:"H:i" }}</p>
                    <p><strong>Dias de Trabalho:</strong> {{ dias_de_trabalho }}</p>
                {% else %}
                    <p><strong>Horário de Entrada:</strong> Não informado</p>
                    <p><strong>Horário de Saída:</strong> Não informado</p>
                    <p><strong>Dias de Trabalho:</strong> Não informado</p>
                {% endif %}
                <p><strong>Centro de Custo:</strong> {{ funcionario_data.centro_de_custo.nome|default:"Não informado" }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">Dados Bancários</div>
            <div class="card-body">
                <p><strong>Banco:</strong> {{ funcionario_data.banco.nome|default:"Não informado" }}</p>
                <p><strong>Agência:</strong> {{ funcionario_data.agencia|default:"Não informado" }}</p>
                <p><strong>Conta:</strong> {{ funcionario_data.conta|default:"Não informado" }}</p>
            </div>
        </div>
    </div>
</div>

<hr />

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">Solicitar Alteração de Endereço</div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %} 
                    {{ form_endereco.as_p }}
                    <button type="submit" name="submit_endereco" class="btn btn-primary">
                        Enviar Solicitação de Endereço
                    </button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">Solicitar Alteração de Dados Bancários</div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %} 
                    {{ form_bancario.as_p }}
                    <button type="submit" name="submit_bancario" class="btn btn-primary">
                        Enviar Solicitação Bancária
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<hr />

<h2>Suas Solicitações</h2>
<div class="row">
    <div class="col-md-6">
        <h4>Alterações de Endereço</h4>
        {% if solicitacoes_endereco %}
        <ul class="list-group">
            {% for s in solicitacoes_endereco %}
            <li class="list-group-item">
                {{ s.data_solicitacao|date:"d/m/Y" }}: Solicitação para CEP {{s.cep}} -
                <span class="fw-bold">Status: {{ s.get_status_display }}</span>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p>Você ainda não fez nenhuma solicitação de endereço.</p>
        {% endif %}
    </div>
    <div class="col-md-6">
        <h4>Alterações Bancárias</h4>
        {% if solicitacoes_bancarias %}
        <ul class="list-group">
            {% for s in solicitacoes_bancarias %}
            <li class="list-group-item">
                {{ s.data_solicitacao|date:"d/m/Y" }}: Alterar para Banco {{s.banco}}, Ag. {{s.agencia}}, Conta {{s.conta}} -
                <span class="fw-bold">Status: {{ s.get_status_display }}</span>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p>Você ainda não fez nenhuma solicitação bancária.</p>
        {% endif %}
    </div>
    <div class="col-md-12 mt-3">
        <h4>Solicitações de Abono</h4>
        {% if solicitacoes_abono %}
        <ul class="list-group">
            {% for s in solicitacoes_abono %}
            <li class="list-group-item">
                {{ s.data_solicitacao|date:"d/m/Y" }}: {{ s.get_tipo_abono_display }} de {{ s.data_inicio|date:"d/m/Y H:i" }} até {{ s.data_fim|date:"d/m/Y H:i" }} -
                <span class="fw-bold">Status: {{ s.get_status_display }}</span>
                {% if s.documento %}
                    <a href="{{ s.documento.url }}" target="_blank" class="small">(Ver Anexo)</a>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p>Você ainda não fez nenhuma solicitação de abono.</p>
        {% endif %}
    </div>
</div>

<hr />

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Lógica para pedir permissão de notificação ---
        if ('Notification' in window) {
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        const cepInput = document.getElementById('id_cep');
        if (cepInput) {
            cepInput.addEventListener('blur', function () {
                const cep = this.value.replace(/\D/g, '');
                if (cep.length === 8) {
                    fetch(`https://viacep.com.br/ws/${cep}/json/`)
                        .then((response) => response.json())
                        .then((data) => {
                            if (!data.erro) {
                                document.getElementById('id_rua').value = data.logradouro;
                                document.getElementById('id_bairro').value = data.bairro;
                                document.getElementById('id_cidade').value = data.localidade;
                                document.getElementById('id_estado').value = data.uf;
                            } else {
                                alert('CEP não encontrado.');
                            }
                        })
                        .catch((error) => console.error('Erro ao buscar CEP:', error));
                }
            });
        }

        // --- Lógica do Cronômetro de Pausa ---
        function updatePauseTimers() {
            const timerElements = document.querySelectorAll('.pause-timer');
            
            timerElements.forEach(timer => {
                // Garante que o timer tem o atributo com o tempo de início
                if (!timer.dataset.pausestart) return;

                const startTime = new Date(timer.dataset.pausestart);
                const now = new Date();
                const diff = now - startTime;

                // Se a data for inválida, não faz nada
                if (isNaN(diff)) {
                    timer.textContent = '';
                    return;
                }

                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                const pad = (num) => num.toString().padStart(2, '0');

                // Formata o tempo e exibe no elemento
                timer.textContent = `(${pad(hours)}:${pad(minutes)}:${pad(seconds)})`;
            });
        }

        // --- Lógica do Cronômetro de Tempo Logado ---
        function updateLoggedInTimer() {
            const timerElement = document.getElementById('logged-in-timer');
            if (!timerElement || !timerElement.dataset.startTime) return;

            const startTime = new Date(timerElement.dataset.startTime);
            const now = new Date();
            const diff = now - startTime;

            if (isNaN(diff)) {
                timerElement.textContent = '00:00:00';
                return;
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            const pad = (num) => num.toString().padStart(2, '0');
            timerElement.textContent = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
        }

        // Inicia a atualização dos cronômetros
        updatePauseTimers(); 
        updateLoggedInTimer();
        setInterval(updatePauseTimers, 1000);
        setInterval(updateLoggedInTimer, 1000);

        // --- Lógica do Countdown da Pausa Programada ---
        let notificationSent = false; // Flag para controlar a notificação
        const notificationSound = new Audio('https://orangefreesounds.com/wp-content/uploads/2025/08/Notification-alert-sound-effect.mp3');

        function updateBreakCountdown() {
            const countdownElement = document.getElementById('break-countdown');
            if (!countdownElement || !countdownElement.dataset.breakEndTime) {
                notificationSent = false; // Reseta a flag se não houver countdown
                return;
            }

            const endTime = new Date(countdownElement.dataset.breakEndTime);
            const now = new Date();
            const diff = endTime - now;

            if (isNaN(diff) || diff < 0) {
                countdownElement.textContent = 'Tempo Esgotado!';
                countdownElement.classList.remove('bg-danger');
                countdownElement.classList.add('bg-success');

                // Envia a notificação apenas uma vez
                if (!notificationSent) {
                    if (Notification.permission === 'granted') {
                        new Notification('Fim da Pausa', {
                            body: 'Seu tempo de pausa programada terminou.',
                            icon: '/static/admin/img/icon-clock.svg'
                        });
                        notificationSound.play();
                    }
                    notificationSent = true;
                }
                return;
            }

            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            const pad = (num) => num.toString().padStart(2, '0');
            countdownElement.textContent = `Fim em: ${pad(minutes)}:${pad(seconds)}`;
        }

        updateBreakCountdown();
        setInterval(updateBreakCountdown, 1000);
    });
</script>

{% endblock %}