Visão Geral do Projeto: Sistema de Gestão de RH (hr_system)

Este documento detalha a arquitetura, os componentes, as funcionalidades e a lógica de negócio da aplicação `hr_system`, um sistema de gestão de RH desenvolvido em Django.

1. Arquitetura Geral

O `hr_system` é uma aplicação web construída sobre o framework Django, seguindo o padrão Model-View-Controller (MVC), embora no Django seja mais precisamente Model-Template-View (MTV). A aplicação é totalmente containerizada usando Docker e Docker Compose, o que garante um ambiente de desenvolvimento e produção consistente e isolado. O banco de dados utilizado é o PostgreSQL.

-   **Django Framework:** Base sólida para o desenvolvimento web, fornecendo ORM, sistema de autenticação, painel administrativo e muito mais.
-   **Docker e Containerização:** Permite empacotar a aplicação e suas dependências em contêineres leves e portáteis. A orquestração é feita com o Docker Compose, que gerencia os serviços da aplicação (`web`), o banco de dados (`db`) e um serviço de agendamento de tarefas (`cron`).
-   **Banco de Dados (PostgreSQL):** Um sistema de gerenciamento de banco de dados relacional robusto e de código aberto, ideal para aplicações que exigem integridade e escalabilidade.
-   **Frontend:** HTML5, CSS3, JavaScript (Vanilla), HTMX (para atualizações dinâmicas)
-   **Framework CSS:** Bootstrap 5
-   **Ambiente:** Docker, Docker Compose
-   **Bibliotecas Python Notáveis:** `psycopg2-binary`, `django-localflavor`.

2. Módulos e Componentes Principais

2.1. `app/` (Configuração do Projeto Django)

-   `settings.py`:
    -   **Configurações Globais:** Define `SECRET_KEY`, `DEBUG` (ativado para desenvolvimento), `ALLOWED_HOSTS`.
    -   **Aplicações Instaladas (`INSTALLED_APPS`):** Inclui as aplicações padrão do Django (`admin`, `auth`, `contenttypes`, `sessions`, `messages`, `staticfiles`) e a aplicação customizada `funcionarios`.
    -   **Middleware:** Gerencia o ciclo de requisição/resposta, incluindo autenticação, sessões e um middleware customizado `funcionarios.middleware.ForcePasswordChangeMiddleware` para forçar a troca de senha no primeiro acesso.
    -   **Configuração de URL (`ROOT_URLCONF`):** Aponta para `app.urls` como o arquivo de rotas principal.
    -   **Templates:** Configurado para buscar templates no diretório `BASE_DIR / "templates"` e nos diretórios `templates/` de cada aplicação.
    -   **Banco de Dados (`DATABASES`):** Configurado para PostgreSQL, com credenciais obtidas de variáveis de ambiente, indicando um setup Docker.
    -   **Internacionalização:** Definido para `pt-br` (português do Brasil) e fuso horário `America/Sao_Paulo`, com suporte a internacionalização e fusos horários (`USE_I18N=True`, `USE_TZ=True`).
    -   **Arquivos Estáticos e de Mídia:** Configuração padrão para servir arquivos estáticos (`STATIC_URL`, `STATIC_ROOT`) e de uploads de usuários (`MEDIA_URL`, `MEDIA_ROOT`).
    -   **Autenticação:** `LOGIN_URL` aponta para a página de login customizada (`funcionarios:login`). `MESSAGE_TAGS` customizado para tags de mensagens do Bootstrap.

-   `urls.py`:
    -   Define as rotas de nível superior do projeto.
    -   `path('admin/', admin.site.urls)`: Inclui as URLs do painel administrativo do Django.
    -   `path('', include('funcionarios.urls'))`: Inclui todas as URLs definidas na aplicação `funcionarios` na raiz do projeto.
    -   Configurado para servir arquivos de mídia em ambiente de desenvolvimento.

2.2. `funcionarios/` (Aplicação Principal)

-   `models.py`: Define a estrutura de dados do sistema.
    -   `Escala`, `Cargo`, `RegraDePausa`, `CentroDeCusto`, `Banco`: Modelos de suporte para a estrutura organizacional.
    -   `Funcionario`: O modelo central, representando um funcionário.
    -   `FuncionarioEscala`: Associa um `Funcionario` a uma `Escala` por um período específico.
    -   `BancoDeHoras`: Registra o balanço de horas (créditos ou débitos) de um funcionário.
    -   `RegistroPonto`: Registra os eventos de ponto (entrada, saída, pausas). O campo `timestamp` foi ajustado para permitir a inserção de dados em testes.
    -   `SolicitacaoHorario`: Registra pedidos de funcionários para bater o ponto fora do horário permitido.
    -   `SolicitacaoAbono`: Registra pedidos de funcionários para abonar faltas ou horas, com suporte a anexos.
    -   `SolicitacaoAlteracaoEndereco`, `SolicitacaoAlteracaoBancaria`: Modelos para solicitações de alteração de dados cadastrais.

-   `views.py`: Contém a lógica de negócio.
    -   `login_view`, `logout_view`, `CustomPasswordChangeView`: Views de autenticação e gestão de usuário.
    -   `home_view`: Dashboard pessoal do funcionário.
    -   `supervisor_dashboard_view`: Dashboard para supervisores com solicitações pendentes da equipe.
    -   `bate_ponto_view`: Processa o registro de ponto, com validações de status, horário e dia da semana.
    -   `relatorio_folha_ponto`: Gera um relatório de folha de ponto para um funcionário em um período.
    -   `relatorio_equipe_view`: **(Novo)** Gera um relatório consolidado para a equipe de um supervisor, totalizando horas extras, devidas e faltas.
    -   `solicitar_horario_view`, `aprovar_solicitacao_horario`, `recusar_solicitacao_horario`: Fluxo de solicitação de ponto fora de hora.
    -   `solicitar_abono_view`, `aprovar_solicitacao_abono`, `recusar_solicitacao_abono`: Fluxo completo para solicitação e aprovação/recusa de abonos.
    -   `tabela_equipe_view`: View auxiliar para o dashboard do supervisor (HTMX).

-   `urls.py`: Define as rotas da aplicação, incluindo as novas rotas para relatórios (`/relatorio/equipe/`) e o fluxo de abonos.

-   `forms.py`: Define os formulários da aplicação.
    -   `RelatorioFolhaPontoForm`: Formulário para filtrar o relatório de folha de ponto.
    -   `RelatorioEquipeForm`: **(Novo)** Formulário para filtrar o relatório de equipe por data.
    -   `SolicitacaoAbonoForm`: Formulário dinâmico para o funcionário solicitar um abono.
    -   `SolicitacaoAlteracaoEnderecoForm`, `SolicitacaoAlteracaoBancariaForm`, `SolicitacaoHorarioForm`: Demais formulários de solicitação.

-   `management/commands/processar_pontos.py`: Comando de gerenciamento para processar os registros de ponto e popular o banco de horas. Agora é executado automaticamente.

-   `templates/`: Contém os arquivos HTML.
    -   `funcionarios/home.html`, `funcionarios/supervisor_dashboard.html`: Dashboards principais.
    -   `funcionarios/relatorio_folha_ponto.html`: Template para exibir o relatório de ponto individual.
    -   `funcionarios/relatorio_equipe.html`: **(Novo)** Template para exibir o relatório consolidado da equipe.
    -   `funcionarios/solicitar_abono.html`: Template com o formulário dinâmico para solicitar abono.
    -   Demais templates para login, troca de senha, etc.

3. Lógica de Negócio e Fluxos Chave

3.1. Gestão de Funcionários e Escalas
-   Cadastro e gestão de dados de funcionários, cargos e escalas de trabalho.

3.2. Registro de Ponto e Controle de Jornada
-   **Bater Ponto:** Funcionários registram entrada, saída e pausas.
-   **Validações:** O sistema valida status do funcionário, dia de trabalho, janela de tolerância, etc.
-   **Solicitações:** Fluxos de aprovação/recusa para ponto fora de hora.

3.3. Banco de Horas Automatizado
-   Um serviço `cron` no Docker executa o comando `processar_pontos` diariamente.
-   O comando analisa os registros do dia anterior, compara com a escala e calcula o saldo de horas (crédito/débito) de cada funcionário, salvando no `BancoDeHoras`.

3.4. Relatórios
-   **Relatório de Folha de Ponto:** Usuários podem gerar um relatório de ponto individual para um período, que exibe marcações, saldo do banco de horas e identifica faltas injustificadas.
-   **Relatório de Equipe:** Supervisores podem gerar um relatório consolidado para sua equipe, visualizando o total de horas extras, horas devidas e faltas por funcionário em um determinado período.

3.5. Solicitação de Abono
-   O sistema detecta faltas recentes não justificadas e as sugere para abono.
-   O funcionário preenche um formulário dinâmico, anexa documentos se necessário, e envia para o supervisor.
-   O supervisor aprova ou recusa; a aprovação gera um crédito correspondente no banco de horas.

4. Tecnologias Utilizadas (Resumo)

-   **Backend:** Python 3.11, Django 5.2
-   **Banco de Dados:** PostgreSQL
-   **Frontend:** HTML5, CSS3, JavaScript (Vanilla), HTMX
-   **Framework CSS:** Bootstrap 5
-   **Ambiente:** Docker, Docker Compose
-   **Bibliotecas Python Notáveis:** `psycopg2-binary`, `django-localflavor`.
