Visão Geral do Projeto: Sistema de Gestão de RH (hr_system)

Este documento detalha a arquitetura, os componentes, as funcionalidades e a lógica de negócio da aplicação `hr_system`, um sistema de gestão de RH desenvolvido em Django.

1. Arquitetura Geral

O `hr_system` é uma aplicação web construída sobre o framework Django, seguindo o padrão Model-View-Controller (MVC), embora no Django seja mais precisamente Model-Template-View (MTV). A aplicação é totalmente containerizada usando Docker e Docker Compose, o que garante um ambiente de desenvolvimento e produção consistente e isolado. O banco de dados utilizado é o PostgreSQL.

-   **Django Framework:** Base sólida para o desenvolvimento web, fornecendo ORM, sistema de autenticação, painel administrativo e muito mais.
-   **Docker e Containerização:** Permite empacotar a aplicação e suas dependências em contêineres leves e portáteis, facilitando a implantação e o gerenciamento de ambientes.
-   **Banco de Dados (PostgreSQL):** Um sistema de gerenciamento de banco de dados relacional robusto e de código aberto, ideal para aplicações que exigem integridade e escalabilidade.
-   **Frontend:** HTML5, CSS3, JavaScript (Vanilla), HTMX (para atualizações dinâmicas)
-   **Framework CSS:** Bootstrap 5
-   **Ambiente:** Docker, Docker Compose
-   **Bibliotecas Python Notáveis:** `psycopg2-binary`, `django-localflavor`.

2. Módulos e Componentes Principais

2.1. `app/` (Configuração do Projeto Django)

-   `settings.py`:
    -   **Configurações Globais:** Define `SECRET_KEY`, `DEBUG` (ativado para desenvolvimento), `ALLOWED_HOSTS`.
    -   **Aplicações Instaladas (`INSTALLED_APPS`):** Inclui as aplicações padrão do Django (`admin`, `auth`, `contenttypes`, `sessions`, `messages`, `staticfiles`) e a aplicação customizada `funcionarios`.
    -   **Middleware:** Gerencia o ciclo de requisição/resposta, incluindo autenticação, sessões e um middleware customizado `funcionarios.middleware.ForcePasswordChangeMiddleware` para forçar a troca de senha no primeiro acesso.
    -   **Configuração de URL (`ROOT_URLCONF`):** Aponta para `app.urls` como o arquivo de rotas principal.
    -   **Templates:** Configurado para buscar templates no diretório `BASE_DIR / "templates"` e nos diretórios `templates/` de cada aplicação.
    -   **Banco de Dados (`DATABASES`):** Configurado para PostgreSQL, com credenciais obtidas de variáveis de ambiente, indicando um setup Docker.
    -   **Internacionalização:** Definido para `pt-br` (português do Brasil) e fuso horário `America/Sao_Paulo`, com suporte a internacionalização e fusos horários (`USE_I18N=True`, `USE_TZ=True`).
    -   **Arquivos Estáticos e de Mídia:** Configuração padrão para servir arquivos estáticos (`STATIC_URL`, `STATIC_ROOT`) e de uploads de usuários (`MEDIA_URL`, `MEDIA_ROOT`).
    -   **Autenticação:** `LOGIN_URL` aponta para a página de login customizada (`funcionarios:login`). `MESSAGE_TAGS` customizado para tags de mensagens do Bootstrap.

-   `urls.py`:
    -   Define as rotas de nível superior do projeto.
    -   `path('admin/', admin.site.urls)`: Inclui as URLs do painel administrativo do Django.
    -   `path('', include('funcionarios.urls'))`: Inclui todas as URLs definidas na aplicação `funcionarios` na raiz do projeto.
    -   Configurado para servir arquivos de mídia em ambiente de desenvolvimento.

2.2. `funcionarios/` (Aplicação Principal)

-   `models.py`: Define a estrutura de dados do sistema.
    -   `Escala`, `Cargo`, `RegraDePausa`, `CentroDeCusto`, `Banco`: Modelos de suporte para a estrutura organizacional.
    -   `Funcionario`: O modelo central, representando um funcionário.
    -   `FuncionarioEscala`: Associa um `Funcionario` a uma `Escala` por um período específico.
    -   `BancoDeHoras`: Registra o balanço de horas (créditos ou débitos) de um funcionário.
    -   `RegistroPonto`: Registra os eventos de ponto (entrada, saída, pausas).
    -   `SolicitacaoHorario`: Registra pedidos de funcionários para bater o ponto fora do horário permitido.
    -   `SolicitacaoAbono`: **(Novo)** Registra pedidos de funcionários para abonar faltas ou horas, com suporte a anexos.
    -   `SolicitacaoAlteracaoEndereco`, `SolicitacaoAlteracaoBancaria`: Modelos para solicitações de alteração de dados cadastrais.

-   `views.py`: Contém a lógica de negócio.
    -   `login_view`, `logout_view`, `CustomPasswordChangeView`: Views de autenticação e gestão de usuário.
    -   `home_view`: Dashboard pessoal do funcionário.
    -   `supervisor_dashboard_view`: Dashboard para supervisores.
    -   `bate_ponto_view`: Processa o registro de ponto, com validações de status, horário e dia da semana.
    -   `relatorio_folha_ponto`: Gera um relatório de folha de ponto para um funcionário em um período, identificando faltas injustificadas.
    -   `solicitar_horario_view`, `aprovar_solicitacao_horario`, `recusar_solicitacao_horario`: Fluxo de solicitação de ponto fora de hora.
    -   `solicitar_abono_view`, `aprovar_solicitacao_abono`, `recusar_solicitacao_abono`: Fluxo completo para solicitação e aprovação/recusa de abonos. A view detecta automaticamente faltas recentes não justificadas para facilitar o preenchimento.
    -   `tabela_equipe_view`: View auxiliar para o dashboard do supervisor (HTMX).

-   `urls.py`: Define as rotas da aplicação, incluindo as novas rotas para relatórios (`/relatorio/`) e o fluxo de abonos (`/solicitar-abono/`, etc.).

-   `forms.py`: Define os formulários da aplicação.
    -   `RelatorioFolhaPontoForm`: Formulário para filtrar o relatório de folha de ponto.
    -   `SolicitacaoAbonoForm`: Formulário dinâmico para o funcionário solicitar um abono. Exibe campos de data ou data/hora com base no tipo de abono (falta ou horas) e valida se a solicitação corresponde a um dia de trabalho válido.
    -   `SolicitacaoAlteracaoEnderecoForm`, `SolicitacaoAlteracaoBancariaForm`, `SolicitacaoHorarioForm`: Demais formulários de solicitação.

-   `management/commands/processar_pontos.py`: Comando de gerenciamento para processar os registros de ponto e popular o banco de horas.

-   `templates/`: Contém os arquivos HTML.
    -   `funcionarios/home.html`, `funcionarios/supervisor_dashboard.html`: Dashboards principais.
    -   `funcionarios/relatorio_folha_ponto.html`: Template para exibir o relatório de ponto.
    -   `funcionarios/solicitar_abono.html`: Template com o formulário dinâmico para solicitar abono e a lista de faltas detectadas.
    -   Demais templates para login, troca de senha, etc.

3. Lógica de Negócio e Fluxos Chave

3.1. Gestão de Funcionários e Escalas
-   Cadastro e gestão de dados de funcionários, cargos e escalas de trabalho.

3.2. Registro de Ponto e Controle de Jornada
-   **Bater Ponto:** Funcionários registram entrada, saída e pausas.
-   **Validações:** O sistema valida:
    -   Unicidade de entrada/saída por dia.
    -   Status do funcionário (deve estar 'ATIVO').
    -   **Dia de Trabalho:** Impede o registro de ponto em dias de folga, conforme a escala.
    -   Janela de tolerância para o horário de entrada.
-   **Solicitações:** Fluxos de aprovação/recusa para ponto fora de hora.

3.3. Banco de Horas
-   Um comando (`processar_pontos`) analisa os registros diários e calcula o saldo de horas (crédito/débito) de cada funcionário, salvando no `BancoDeHoras`.

3.4. Relatório de Folha de Ponto
-   Usuários (funcionários e supervisores) podem gerar um relatório de ponto para um período específico.
-   O relatório exibe as marcações de cada dia, o saldo do banco de horas e identifica **faltas injustificadas** (dias de trabalho sem registro de ponto).

3.5. Solicitação de Abono
-   **Detecção de Faltas:** A página de solicitação verifica os últimos 30 dias (a partir da data de contratação do funcionário) e lista os dias em que ele deveria ter trabalhado (conforme sua escala específica para aquele dia) mas não o fez, sugerindo-os para abono.
-   **Solicitação Inteligente:** O funcionário pode clicar em uma falta detectada para pré-preencher o formulário, ou preenchê-lo manualmente. O formulário é dinâmico:
    -   Para **"Abono de Falta"**, exibe um único campo de data.
    -   Para **"Abono de Atraso/Horas"**, exibe campos de data e hora de início e fim.
-   **Validação:** O formulário impede o envio de solicitações para dias em que o funcionário estava de folga.
-   **Anexo e Análise pelo Supervisor:** O funcionário pode explicar o motivo e anexar um documento. O supervisor visualiza o pedido em seu dashboard, pode baixar o anexo e escolher "Aprovar" ou "Recusar".
-   **Lógica de Aprovação:** Ao aprovar, o sistema cria automaticamente um registro de crédito no `BancoDeHoras` do funcionário, compensando o período solicitado.

4. Tecnologias Utilizadas (Resumo)

-   **Backend:** Python 3.11, Django 5.2
-   **Banco de Dados:** PostgreSQL
-   **Frontend:** HTML5, CSS3, JavaScript (Vanilla), HTMX
-   **Framework CSS:** Bootstrap 5
-   **Ambiente:** Docker, Docker Compose
-   **Bibliotecas Python Notáveis:** `psycopg2-binary`, `django-localflavor`.
