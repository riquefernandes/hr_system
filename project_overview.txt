Visão Geral do Projeto: Sistema de Gestão de RH (hr_system)

Este documento detalha a arquitetura, os componentes, as funcionalidades e a lógica de negócio da aplicação `hr_system`, um sistema de gestão de RH desenvolvido em Django.

1. Arquitetura Geral

O `hr_system` é uma aplicação web construída sobre o framework Django, seguindo o padrão Model-View-Controller (MVC), embora no Django seja mais precisamente Model-Template-View (MTV). A aplicação é totalmente containerizada usando Docker e Docker Compose, o que garante um ambiente de desenvolvimento e produção consistente e isolado. O banco de dados utilizado é o PostgreSQL.

-   **Django Framework:** Base sólida para o desenvolvimento web, fornecendo ORM, sistema de autenticação, painel administrativo e muito mais.
-   **Docker e Containerização:** Permite empacotar a aplicação e suas dependências em contêineres leves e portáteis, facilitando a implantação e o gerenciamento de ambientes.
-   **Banco de Dados (PostgreSQL):** Um sistema de gerenciamento de banco de dados relacional robusto e de código aberto, ideal para aplicações que exigem integridade e escalabilidade.
-   **Frontend:** HTML5, CSS3, JavaScript (Vanilla), HTMX (para atualizações dinâmicas)
-   **Framework CSS:** Bootstrap 5
-   **Ambiente:** Docker, Docker Compose
-   **Bibliotecas Python Notáveis:** `psycopg2-binary`, `django-localflavor`.

2. Módulos e Componentes Principais

2.1. `app/` (Configuração do Projeto Django)

-   `settings.py`:
    -   **Configurações Globais:** Define `SECRET_KEY`, `DEBUG` (ativado para desenvolvimento), `ALLOWED_HOSTS`.
    -   **Aplicações Instaladas (`INSTALLED_APPS`):** Inclui as aplicações padrão do Django (`admin`, `auth`, `contenttypes`, `sessions`, `messages`, `staticfiles`) e a aplicação customizada `funcionarios`.
    -   **Middleware:** Gerencia o ciclo de requisição/resposta, incluindo autenticação, sessões e um middleware customizado `funcionarios.middleware.ForcePasswordChangeMiddleware` para forçar a troca de senha no primeiro acesso.
    -   **Configuração de URL (`ROOT_URLCONF`):** Aponta para `app.urls` como o arquivo de rotas principal.
    -   **Templates:** Configurado para buscar templates no diretório `BASE_DIR / "templates"` e nos diretórios `templates/` de cada aplicação.
    -   **Banco de Dados (`DATABASES`):** Configurado para PostgreSQL, com credenciais obtidas de variáveis de ambiente, indicando um setup Docker.
    -   **Internacionalização:** Definido para `pt-br` (português do Brasil) e fuso horário `America/Sao_Paulo`, com suporte a internacionalização e fusos horários (`USE_I18N=True`, `USE_TZ=True`).
    -   **Arquivos Estáticos:** Configuração padrão para servir arquivos estáticos.
    -   **Autenticação:** `LOGIN_URL` aponta para a página de login customizada (`funcionarios:login`). `MESSAGE_TAGS` customizado para tags de mensagens do Bootstrap.

-   `urls.py`:
    -   Define as rotas de nível superior do projeto.
    -   `path('admin/', admin.site.urls)`: Inclui as URLs do painel administrativo do Django.
    -   `path('', include('funcionarios.urls'))`: Inclui todas as URLs definidas na aplicação `funcionarios` na raiz do projeto.

2.2. `funcionarios/` (Aplicação Principal)

-   `models.py`: Define a estrutura de dados do sistema.
    -   `Escala`: Define um padrão de horário de trabalho (nome, dias da semana, horário de entrada/saída, duração do almoço).
    -   `Cargo`: Representa os cargos na empresa, com um CBO e uma `escala_padrao` (ForeignKey para `Escala`).
    -   `RegraDePausa`: Define regras de pausas específicas para cada cargo (nome, ordem, duração em minutos).
    -   `CentroDeCusto`: Representa os centros de custo.
    -   `Banco`: Informações de bancos.
    -   `Funcionario`: O modelo central, representando um funcionário. Possui campos para informações pessoais, contato, documentos, dados de trabalho (cargo, centro de custo, supervisor), dados bancários e status operacional. Relacionado a um `User` do Django.
    -   `FuncionarioEscala`: Associa um `Funcionario` a uma `Escala` por um período específico, permitindo flexibilidade na atribuição de escalas.
    -   `BancoDeHoras`: Registra o balanço de horas (créditos ou débitos) de um funcionário para um determinado dia, com descrição e data de processamento.
    -   `SolicitacaoHorario`: Registra pedidos de funcionários para bater o ponto fora do horário, incluindo motivo, status (Pendente, Aprovado, Recusado) e informações de análise pelo supervisor.
    -   `SolicitacaoAlteracaoEndereco`: Registra solicitações de funcionários para alterar dados de endereço.
    -   `SolicitacaoAlteracaoBancaria`: Registra solicitações de funcionários para alterar dados bancários.
    -   `RegistroPonto`: Registra os eventos de ponto (entrada, saída, pausas) de um funcionário.

-   `views.py`: Contém a lógica de negócio e as funções que respondem às requisições HTTP.
    -   `login_view`: Lida com a autenticação de usuários.
    -   `CustomPasswordChangeView`: View customizada para a troca de senha, garantindo que a flag `deve_alterar_senha` seja desativada após a troca.
    -   `supervisor_dashboard_view`: Exibe o dashboard para supervisores, mostrando a equipe e solicitações pendentes.
    -   `home_view`: Dashboard pessoal do funcionário, exibindo dados cadastrais, status operacional, saldo do banco de horas e formulários de solicitação.
    -   `bate_ponto_view`: Processa o registro de ponto (entrada, saída, pausas). Inclui validações de horário de entrada baseadas na escala e redireciona para `solicitar_horario_view` se o ponto for fora da janela permitida.
    -   `solicitar_horario_view`: Permite que o funcionário envie uma solicitação para bater o ponto fora de hora, explicando o motivo.
    -   `tabela_equipe_view`: View auxiliar para o dashboard do supervisor, retornando a tabela da equipe via HTMX.
    -   `aprovar_solicitacao_horario`: Lógica para aprovar uma `SolicitacaoHorario` por um supervisor.
    -   `recusar_solicitacao_horario`: Lógica para recusar uma `SolicitacaoHorario` por um supervisor.
    -   `logout_view`: Lida com o logout de usuários.

-   `urls.py`: Define as rotas específicas da aplicação `funcionarios`. Inclui rotas para login, home, dashboard do supervisor, registro de ponto, solicitações de alteração e as novas rotas para solicitação e aprovação/recusa de ponto fora de hora.

-   `admin.py`: Customiza o painel administrativo do Django para os modelos da aplicação `funcionarios`.
    -   `FuncionarioAdmin`: Configura a exibição e edição de funcionários, incluindo campos somente leitura, fieldsets e um inline para `FuncionarioEscala`.
    -   `RegraDePausaInline`: Permite gerenciar regras de pausa diretamente na página de edição de `Cargo`.
    -   `CargoAdmin`: Configura a exibição de cargos, incluindo o inline para regras de pausa.
    -   `SolicitacaoAlteracaoEnderecoAdmin`, `SolicitacaoAlteracaoBancariaAdmin`: Configuram a exibição e ações para aprovação de solicitações de alteração cadastral.
    -   `EscalaAdmin`: Configura a exibição e edição de `Escala`s.
    -   `BancoDeHorasAdmin`: Configura a exibição de registros de `BancoDeHoras` como somente leitura.
    -   `SolicitacaoHorarioAdmin`: Configura a exibição de `SolicitacaoHorario`s, também com campos somente leitura para análise.

-   `forms.py`: Define os formulários utilizados na aplicação.
    -   `SolicitacaoAlteracaoEnderecoForm`, `SolicitacaoAlteracaoBancariaForm`: Formulários para as respectivas solicitações de alteração.
    -   `SolicitacaoHorarioForm`: Formulário para o funcionário solicitar ponto fora de hora.

-   `management/commands/processar_pontos.py`: Um comando de gerenciamento customizado do Django.
    -   `Command`: Classe principal do comando.
    -   `add_arguments`: Permite passar uma data específica como argumento.
    -   `handle`: Método principal que orquestra o processamento.
    -   `process_employee`: Lógica central que, para cada funcionário ativo, encontra sua escala, obtém os registros de ponto do dia, calcula a jornada líquida, compara com a carga horária esperada da escala e cria/atualiza um registro em `BancoDeHoras` com a diferença (crédito/débito).
    -   `calculate_break_time`: Função auxiliar para calcular a duração total de pausas (café/almoço).
    -   `get_description`: Função auxiliar para gerar uma descrição para o registro de `BancoDeHoras` (ex: "Atraso", "Horas extras").

-   `templates/`: Contém os arquivos HTML que definem a interface do usuário.
    -   `funcionarios/home.html`: Dashboard do funcionário.
    -   `funcionarios/supervisor_dashboard.html`: Dashboard do supervisor.
    -   `funcionarios/_tabela_equipe.html`: Partial HTML para a tabela da equipe no dashboard do supervisor (carregado via HTMX).
    -   `funcionarios/solicitar_horario.html`: Formulário para solicitação de ponto fora de hora.
    -   `registration/password_change_form.html`, `registration/password_change_done.html`: Templates para o fluxo de troca de senha.

3. Lógica de Negócio e Fluxos Chave

3.1. Gestão de Funcionários
-   **Cadastro:** Funcionários são cadastrados via painel administrativo, com criação automática de usuário de login e senha provisória.
-   **Informações Detalhadas:** Armazena dados pessoais, de contato, documentos, dados de trabalho e bancários.
-   **Status:** Controla o status geral (Ativo, Férias, Afastado, Desligado) e operacional (Disponível, Em Pausa, Offline).

3.2. Registro de Ponto e Controle de Jornada
-   **Bater Ponto (Entrada/Saída/Pausas):** Funcionários registram seus eventos de ponto através de uma interface simples.
-   **Restrição de Entrada por Escala:** Ao tentar registrar a entrada, o sistema verifica se o horário está dentro de uma janela de tolerância (30 minutos antes a 60 minutos depois) do horário de entrada definido na escala do funcionário para aquele dia.
-   **Solicitação de Ponto Fora de Hora e Aprovação do Supervisor:**
    -   Se o funcionário tentar bater o ponto de entrada fora da janela permitida e não tiver uma solicitação aprovada, ele é redirecionado para um formulário de `SolicitacaoHorario`.
    -   O funcionário preenche o motivo e envia a solicitação.
    -   Supervisores podem visualizar as solicitações pendentes de sua equipe em seu dashboard e aprová-las ou recusá-las.
    -   Uma vez aprovada, o funcionário pode então registrar o ponto para aquele dia.
-   **Cálculo de Pausas:** O sistema calcula a duração das pausas (café e almoço) com base nos registros de ponto.
-   **Limites de Pausa:** Regras de pausas (quantidade e duração) são definidas por cargo e aplicadas, com alertas visuais para o supervisor quando excedidas.

3.3. Gestão de Escalas
-   **Definição de Escalas:** Administradores criam padrões de escalas com dias da semana, horários de entrada/saída e duração de almoço.
-   **Atribuição Flexível:** Escalas podem ser atribuídas como padrão a um cargo ou individualmente a um funcionário por um período, permitindo gerenciar turnos e mudanças de escala.

3.4. Banco de Horas
-   **Processamento Diário:** Um comando de gerenciamento (`processar_pontos`) é executado para calcular o saldo de horas de cada funcionário.
-   **Cálculo:** Compara a jornada de trabalho real (baseada nos registros de ponto, descontando pausas) com a carga horária esperada da escala.
-   **Registro:** A diferença (minutos positivos para horas extras, negativos para atrasos/saídas antecipadas) é registrada no `BancoDeHoras`.
-   **Visualização:** Funcionários podem ver seu saldo total de banco de horas em seu dashboard.

3.5. Solicitações de Alteração Cadastral
-   Funcionários podem solicitar alterações em seu endereço e dados bancários através de formulários dedicados.
-   Administradores aprovam ou recusam essas solicitações, que atualizam automaticamente os dados do funcionário.

3.6. Visão do Supervisor
-   **Dashboard de Equipe:** Supervisores têm uma visão geral em tempo real do status operacional de sua equipe.
-   **Monitoramento de Pausas:** Cronômetros de pausa em tempo real com alertas visuais para pausas excedidas.
-   **Gestão de Solicitações:** Gerencia as solicitações de ponto fora de hora de sua equipe.

4. Tecnologias Utilizadas (Resumo)

-   **Backend:** Python 3.11, Django 5.2
-   **Banco de Dados:** PostgreSQL
-   **Frontend:** HTML5, CSS3, JavaScript (Vanilla), HTMX (para atualizações dinâmicas)
-   **Framework CSS:** Bootstrap 5
-   **Ambiente:** Docker, Docker Compose
-   **Bibliotecas Python Notáveis:** `psycopg2-binary`, `django-localflavor`.
